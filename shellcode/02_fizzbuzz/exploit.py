#!/usr/bin/env python3

import pwn

pwn.context.arch = 'amd64'
conn = pwn.remote('tasks.ws24.softsec.rub.de', 32862)
'''
i want somthing like the following in assembly
p=0
while(p<2048) {
     if (elements[i] % 15 == 0) {
        elements[i] = 2;
    } else if (elements[i] % 3 == 0) {
        elements[i] = 0;
    } else if (elements[i] % 5 == 0) {
        elements[i] = 1;
    } else {
        elements[i] = 3;
    }
    p += 1;
}
'''
shellcode = pwn.asm('''
    xor rcx, rcx;           # rcx is loop var running from 0...2047                    
while_start:
    cmp rcx, 2048;
    jae while_exit;         # if rcx >= (above or equal), exit  
    
    mov r10d, 2;   # r10d (32-bit) has the new value that will replace previous  
    xor edx, edx;  # zero in edx for division we divide 64-bit / 32-bit = 32-bit                                   
    mov eax, [rdi + rcx*4]; # copy array element to eax (32bit)
    mov r11d, 15;
    div r11d;      # edx:eax/15 = eax Remainder edx
    cmp edx, 0;
    je replace;    # replace with value 2 if remainder 0                   

    mov r10d, 0; 
    xor edx, edx; 
    mov eax, [rdi + rcx*4];
    mov r11d, 3;
    div r11d;
    cmp edx, 0;
    je replace; # replace with value 0

    mov r10d, 1;  
    xor edx, edx;    
    mov eax, [rdi + rcx*4];
    mov r11d, 5;
    div r11d;
    cmp edx, 0;
    je replace; # replace with value 1

    mov r10d, 3; # else replace with 3
    je replace;                        

replace:
    mov [rdi + rcx*4], r10d   
    inc rcx;
    jmp while_start;
while_exit:
    ret       
''')

print(shellcode.hex())
conn.recvuntil(b'please enter your (hex-encoded) shellcode, at most 4096 bytes:')
conn.sendline(shellcode.hex())
#softsec{jqCF9ssJUHNbQN425vd73x0f4g1gFI7L7ANl7ABxE1i3ZqWWpKWLhqF4-G3U3lVB}
conn.interactive()